---
# Tiny Breakers 배포 Playbook (Self-hosted runner용)
# 개발 서버에서 직접 실행되므로 localhost로 배포
- name: Deploy Tiny Breakers to Development Server
  hosts: localhost
  gather_facts: yes
  
  vars:
    go_binary_name: server
    # Playbook 디렉토리 기준으로 상대 경로 계산
    # playbook_dir는 ansible/playbooks이므로 ../../server로 이동
    local_binary_dir: "{{ playbook_dir }}/../../server"
    
  tasks:
    - name: Print binary directory for debugging
      debug:
        msg: "Binary directory: {{ local_binary_dir }} (resolved to {{ local_binary_dir | expanduser | realpath }})"

    - name: Check if game server binary exists
      stat:
        path: "{{ local_binary_dir }}/{{ go_binary_name }}"
      register: game_binary_check
      failed_when: not game_binary_check.stat.exists

    - name: Check if batch server binary exists locally
      stat:
        path: "{{ local_binary_dir }}/{{ go_binary_name }}-batch"
      register: batch_binary_check

    - name: Create game server directory
      file:
        path: "{{ game_server_path }}"
        state: directory
        owner: ki
        group: ki
        mode: '0755'

    - name: Create batch server directory
      file:
        path: "{{ batch_server_path }}"
        state: directory
        owner: ki
        group: ki
        mode: '0755'

    - name: Copy game server binary from GitHub Actions
      copy:
        src: "{{ local_binary_dir }}/{{ go_binary_name }}"
        dest: "{{ game_server_path }}/{{ go_binary_name }}"
        owner: ki
        group: ki
        mode: '0755'
      when: game_binary_check.stat.exists

    - name: Copy batch server binary from GitHub Actions
      copy:
        src: "{{ local_binary_dir }}/{{ go_binary_name }}-batch"
        dest: "{{ batch_server_path }}/{{ go_binary_name }}-batch"
        owner: ki
        group: ki
        mode: '0755'
      when: batch_binary_check.stat.exists
      failed_when: false

    - name: Copy .env file to game server (if exists)
      copy:
        src: "{{ local_binary_dir }}/.env"
        dest: "{{ game_server_path }}/.env"
        owner: ki
        group: ki
        mode: '0600'
      register: env_file_copy
      failed_when: false
      changed_when: env_file_copy is defined and env_file_copy.changed

    - name: Create systemd service file for game server
      become: yes
      template:
        src: game-server.service.j2
        dest: /etc/systemd/system/tiny-breakers-game.service
        mode: '0644'
      vars:
        service_user: ki
        service_path: "{{ game_server_path }}"
        binary_name: "{{ go_binary_name }}"
      notify: reload systemd

    - name: Create systemd service file for batch server
      become: yes
      template:
        src: batch-server.service.j2
        dest: /etc/systemd/system/tiny-breakers-batch.service
        mode: '0644'
      vars:
        service_user: ki
        service_path: "{{ batch_server_path }}"
        binary_name: "{{ go_binary_name }}-batch"
      when: batch_binary_check.stat.exists
      notify: reload systemd

    - name: Restart game server
      become: yes
      systemd:
        name: tiny-breakers-game
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Restart batch server
      become: yes
      systemd:
        name: tiny-breakers-batch
        state: restarted
        enabled: yes
        daemon_reload: yes
      when: batch_binary_check.stat.exists
      failed_when: false

  handlers:
    - name: reload systemd
      become: yes
      systemd:
        daemon_reload: yes

---
# Tiny Breakers 배포 Playbook (Self-hosted runner용 - Docker)
# 개발 서버에서 직접 실행되므로 localhost로 배포
- name: Deploy Tiny Breakers to Development Server (Docker)
  hosts: localhost
  gather_facts: yes
  
  vars:
    app_name: tiny-breakers
    docker_project_dir: "{{ playbook_dir }}/../../server"
    docker_image_game: "{{ app_name }}-game:latest"
    docker_image_batch: "{{ app_name }}-batch:latest"
    docker_container_game: "{{ app_name }}-game-server"
    docker_container_batch: "{{ app_name }}-batch-server"
    
  tasks:
    - name: Print deployment information
      debug:
        msg: |
          Deploying {{ app_name }} with Docker
          Project directory: {{ docker_project_dir }}
          Game image: {{ docker_image_game }}
          Batch image: {{ docker_image_batch }}

    - name: Check if docker-compose.yml exists
      stat:
        path: "{{ docker_project_dir }}/docker-compose.yml"
      register: docker_compose_check
      failed_when: not docker_compose_check.stat.exists

    - name: Check if .env file exists
      stat:
        path: "{{ docker_project_dir }}/.env"
      register: env_file_check

    - name: Stop existing containers (if any)
      become: yes
      shell: |
        cd {{ docker_project_dir }}
        docker-compose down || true
      changed_when: false

    - name: Build Docker images
      become: yes
      shell: |
        cd {{ docker_project_dir }}
        docker-compose build --no-cache
      register: docker_build_result

    - name: Display build result
      debug:
        msg: "Docker build completed successfully"
      when: docker_build_result is succeeded

    - name: Start containers with docker-compose
      become: yes
      shell: |
        cd {{ docker_project_dir }}
        docker-compose up -d
      environment:
        COMPOSE_FILE: "{{ docker_project_dir }}/docker-compose.yml"
      register: docker_up_result

    - name: Display docker-compose up result
      debug:
        msg: "Docker containers started successfully"
      when: docker_up_result is succeeded

    - name: Wait for game server to be ready
      become: yes
      shell: |
        docker ps | grep {{ docker_container_game }} | grep healthy
      retries: 10
      delay: 5
      register: health_check
      until: health_check is succeeded
      failed_when: false

    - name: Display running containers
      become: yes
      shell: |
        docker ps --filter "name={{ app_name }}"
      register: running_containers

    - name: Show running containers
      debug:
        msg: "{{ running_containers.stdout_lines }}"

    - name: Show container logs (last 20 lines)
      become: yes
      shell: |
        echo "=== Game Server Logs ==="
        docker logs --tail 20 {{ docker_container_game }} || echo "Game server not running"
        echo ""
        echo "=== Batch Server Logs ==="
        docker logs --tail 20 {{ docker_container_batch }} || echo "Batch server not running"
      register: container_logs

    - name: Display logs
      debug:
        msg: "{{ container_logs.stdout }}"

    - name: Deployment status
      debug:
        msg: |
          ✅ Deployment completed!
          
          Container Status:
          - Game Server: {{ docker_container_game }}
          - Batch Server: {{ docker_container_batch }}
          
          Useful commands:
          - View logs: docker logs -f {{ docker_container_game }}
          - Stop containers: docker-compose -f {{ docker_project_dir }}/docker-compose.yml down
          - Restart containers: docker-compose -f {{ docker_project_dir }}/docker-compose.yml restart
          - View running containers: docker ps --filter "name={{ app_name }}"

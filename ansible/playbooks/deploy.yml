---
# Tiny Breakers 배포 Playbook
# dev 브랜치에 push되면 자동으로 실행됩니다
# GitHub Actions에서 빌드한 바이너리를 개발 서버로 전송합니다
- name: Deploy Tiny Breakers to Development Server
  hosts: dev-server
  become: yes
  gather_facts: yes
  
  vars:
    go_binary_name: server
    # GitHub Actions에서 빌드된 바이너리 경로 (로컬)
    # ansible 디렉토리에서 실행되므로 상대 경로는 ../server
    local_binary_dir: ../server
    
  tasks:

    - name: Create game server directory
      file:
        path: "{{ game_server_path }}"
        state: directory
        owner: ki
        group: ki
        mode: '0755'

    - name: Create batch server directory
      file:
        path: "{{ batch_server_path }}"
        state: directory
        owner: ki
        group: ki
        mode: '0755'

    - name: Check if batch server binary exists locally
      stat:
        path: "{{ local_binary_dir }}/{{ go_binary_name }}-batch"
      register: batch_binary_check

    - name: Copy game server binary from GitHub Actions
      copy:
        src: "{{ local_binary_dir }}/{{ go_binary_name }}"
        dest: "{{ game_server_path }}/{{ go_binary_name }}"
        owner: ki
        group: ki
        mode: '0755'

    - name: Copy batch server binary from GitHub Actions
      copy:
        src: "{{ local_binary_dir }}/{{ go_binary_name }}-batch"
        dest: "{{ batch_server_path }}/{{ go_binary_name }}-batch"
        owner: ki
        group: ki
        mode: '0755'
      when: batch_binary_check.stat.exists
      failed_when: false

    - name: Copy .env file to game server (if exists)
      copy:
        src: "{{ local_binary_dir }}/.env"
        dest: "{{ game_server_path }}/.env"
        owner: ki
        group: ki
        mode: '0600'
      when: item.stat.exists
      loop:
        - path: "{{ local_binary_dir }}/.env"
      register: env_file_check
      failed_when: false
      changed_when: false

    - name: Create systemd service file for game server
      template:
        src: game-server.service.j2
        dest: /etc/systemd/system/tiny-breakers-game.service
        mode: '0644'
      vars:
        service_user: ki
        service_path: "{{ game_server_path }}"
        binary_name: "{{ go_binary_name }}"
      notify: reload systemd

    - name: Create systemd service file for batch server
      template:
        src: batch-server.service.j2
        dest: /etc/systemd/system/tiny-breakers-batch.service
        mode: '0644'
      vars:
        service_user: ki
        service_path: "{{ batch_server_path }}"
        binary_name: "{{ go_binary_name }}-batch"
      when: batch_binary_check.stat.exists
      notify: reload systemd

    - name: Restart game server
      systemd:
        name: tiny-breakers-game
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Restart batch server
      systemd:
        name: tiny-breakers-batch
        state: restarted
        enabled: yes
        daemon_reload: yes
      when: batch_binary_check.stat.exists
      failed_when: false

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
